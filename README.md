Требования к модулю принятия платежей по стандарту платежной системы 
"ONE CLICK"

Для взаимодействия с платежной системой "ONE CLICK", модуль принятия платежей должен уметь обрабатывать следующие типы запросов:

* `POST "/api/validate"` (с параметрами в теле запроса) – валидация реквизитов платежа.
* `POST "/api/transactions/:id"` (с параметрами в теле запроса) – процедура запуска транзакции.
* `GET  "/api/transactions/:id"` – получение информации о транзакции (по `:id`).
* `DELETE "/api/transactions/:id"` – процедура отмены транзакции (по `:id`).
* `GET "/api/transactions?begin={datetime}&end={datetime}"` – получение списка транзакций для отчетов (актов сверки).


### Валидация реквизитов платежа

На POST-запрос `/api/validate` модуль должен произвести поиск
в БД пользователей (лицевых счетов/аккаунтов/и т.д.) по реквизиту
переданному в теле POST-запроса `params['requisite']`.

В случае если пользователь/лицевой счет **найден**, модуль отвечает статусом `[200 "OK"]`,
и, если доступно, идентификационными данными пользователя, например "Ф.И.О." в теле ответа `res.body`.

Если интеграция требует наличие дополнительных полей, модуль может отвечать в формате JSON (`Content-Type: application/json`). В этом случае, идентификационные данные (Ф.И.О.) должны отправляться в поле `signature`.

**Например:**
```json
{
  "signature": "Аскаров Аскар Аскарович",
  "status": "unidentified",
  "max-amount": "15000.00"
}
```

В случае если пользователь/лицевой счет **не найден**, модуль отвечает статусом `[404 "Not Found"]`.

В случае если пользователь **найден, но** по каким то причинам не может принимать на свой счет платежи,
модуль отвечает статусом `[403 "Forbidden"]`, и сообщением описывающем причину невозможности пополнения
в теле ответа `res.body`.


### Процедура выполнения транзакции

POST-запрос `/api/transactions/:id` должен осуществить транзакцию.

Параметр `:id` (в конце пути url запроса) является уникальным идентификатором транзакции в системе "ONE CLICK".

**Важно: модуль должен гарантировать уникальность транзакций в своей системе не обрабатывая транзакции с одинаковыми id дважды!**

Если танзакция с таким `id` уже была запущена/завершена, модуль должен отвечать таким-же статусом.

Запрос на осуществление транзакции содержит следующие параметры:

* `requisite` – реквизит платежа (номер телефона/лицевой счет/email и т.д.).
* `amount` – сумма пополнения в формате `decimal(8,2)` с точкой в качестве разделителя (например `12.45`, `55.5` или `25`).
* `timestamp` – дата и время инициализации транзакции в системе "ONE CLICK" в формате [ISO8601](https://ru.wikipedia.org/wiki/ISO_8601).

Пример запроса на выполнение транзакции:

```js
// POST /api/transactions/5648dc5077ba42ee6b13ff6f
{
  "requisite": "77273573535",
  "amount": 12.45,
  "timestamp": "2018-02-11T16:15:30.786Z"
}
```

Процедура запуска транзакции предварительно запускает процесс повторной валидации реквизитов платежа,
и в случае невалидности параметров может отвечать теми же статусами (`[404 "Not Found"]` или
`[403 "Forbidden"]` с сообщением о причине в теле ответа).

После успешной валидации, модуль должен произвести начисление на сумму указанную в поле `amount` на лицевой счет клиента.

При успешном завершении транзакции, модуль должен отвечать статусом `[200 "OK"]`, и информацией о выполненной транзакции внутри системы модуля (см. "Получение информации о транзакции").

Если на выполнение транзакции требуется больше времени, например модуль является проксирующим и
отправляет транзакции дальше другой системе (типа процессинг), то на запрос осуществить транзакцию
может отвечать статусом `[202 "Accepted"]` и соответствующим статусом транзкции (`initialized` или `processing`),
при получении такого статуса, система будет повторно отправлять запросы на обновление статуса транзакции
пока не получит статус `success`, `failure` или `cancelled`.
Задержка между повторными запросами будет увеличиваться экспоненциально.

Некоторые акцептанты могут вести работу по предоплате, и в случае недостаточного баланса
модуль может отвечать статусом `[402 "Payment Required"]`. В этом случае система "ONE CLICK" моментально
уведомит администраторов о произошедшей ошибке и через некоторое время попытается повтрить запрос.


### Получение информации о транзакции

Информацию о транзакции модуль должен отправлять в ответ на запрос осуществления транзакции (`POST /api/transactions/:id`), и на запрос получения информации о транзакции `GET /api/transactions/:id`.

Каждая транзакция внутри системы модуля должна содержать следующие поля:

* `id` – (отправленный системой ONE CLICK) – уникальный идентификатор транзакции.
* `requisite` – реквизит платежа (номер телефона/лицевой счет/email и т.д.).
* `amount` – сумма пополнения в формате `decimal(8,2)` с точкой в качестве разделителя (например `12.45`, `55.5` или `25`).
* `status` (обязательно в случае принятия модулем платежа) – статус выполнения транзакции, должен быть одним из:
  - `initialized` – транзакция инициализирована.
  - `pending` – транзакция, по какой-то причине "заморожена", и требует рассмотрения персоналом.
  - `processing` – транзакция в процессе.
  - `success` – транзакция успешно завершена, средства зачислены на лицевой счет клиента.
  - `failure` – в процессе осуществления транзакции произошла ошибка (как правило, должна сопровождаться полем `message`).
  - `cancelled` – транзакция отменена (может сопровождаться полем `message`).
* `message` – для транзакций со статусом `pending`, `failure` или `cancelled` должно содержать сообщение об ошибке или причину.
* `timestamp` – дата и время осуществления транзакции в формате [ISO8601](https://ru.wikipedia.org/wiki/ISO_8601).

Также, информация о транзакции может содержать поле `internal`, с помощью которого модуль может возвращать любые внутренние данные для идентификации транзакции. Например: внутренний идентификатор транзакции в БД модуля, комментарии, номер чека и т.д.

Примеры ответов содержащих информацию о транзакции:

#### Транзакция инициализирована

```json
{
  "id": "5648dc5077ba42ee6b13ff6f",
  "requisite": "77273573535",
  "amount": 12.45,
  "status": "initialized",
  "internal": { "id": 10004 }
}
```

#### Транзакция ожидает рассмотрения персоналом

```json
{
  "id": "5648dc5077ba42ee6b13ff6f",
  "requisite": "77273573535",
  "amount": 12.45,
  "status": "pending",
  "message": "Транзакция ожидает рассмотрения персоналом",
  "internal": { "id": 10004 }
}
```

#### Транзакция в процессе

```json
{
  "id": "5648dc5077ba42ee6b13ff6f",
  "requisite": "77273573535",
  "amount": 12.45,
  "status": "processing",
  "internal": { "id": 10004 }
}
```

#### Транзакция успешно завершена

```json
{
  "id": "5648dc5077ba42ee6b13ff6f",
  "requisite": "77273573535",
  "amount": 12.45,
  "status": "success",
  "timestamp": "2018-02-11T16:15:31.390Z",
  "internal": { "id": 10004 }
}
```

#### В процессе выполнения транзакции произошла ошибка

```json
{
  "id": "5648dc5077ba42ee6b13ff6f",
  "requisite": "77273573535",
  "amount": 12.45,
  "status": "failure",
  "message": "Внутренняя ошибка системы",
  "timestamp": "2018-02-11T16:15:31.390Z",
  "internal": { "id": 10004 }
}
```

#### Транзакция отменена

```json
{
  "id": "5648dc5077ba42ee6b13ff6f",
  "requisite": "77273573535",
  "amount": 12.45,
  "status": "cancelled",
  "message": "Отменено по запросу клиента",
  "timestamp": "2018-02-11T18:22:03.667Z",
  "internal": { "id": 10004 }
}
```

### Процедура отмены транзакции

DELETE-запрос `/api/transactions/:id` модуль должен отменить транзакцию.

Параметр `:id` (в конце пути url запроса) является уникальным идентификатором транзакции.

Если транзакция с таким `id` не найдена, модуль может отвечать статусом `[404 "Not Found"]`.

При успешно произведенной отмене транзакции система ожидает ответ со статусом `[200 "OK"]`.

Если танзакция с таким `id` уже была отменена, модуль должен отвечать таким-же статусом, но не производить отмену транзакции повторно.

В случае когда отмена транзакции невозможна, модуль может отвечать статусом `[405 "Method Not Allowed"]` и, опционально, сообщением о причине невозможности отмены.


### Обработка ошибок запросов к модулю

На любой из вышеперечисленных запросов от системы, модуль может отвечать сатусом `[500 "Internal Server Error"]` в случае внутренних ошибок и неполадок системы. Информация выводимая в теле ответа воспринимается системой как причина ошибки и записывется в журнал. При получении статуса `[500 "Internal Server Error"]` система "ONE CLICK" будет повторно пытаться отправить такой же запрос снова. Задержка между повторными запросами будет увеличиваться экспоненциально.

В случае неверного формата запроса (неверные параметры или навалидные значения) модуль может отвечать статусами `[400 "Bad Request"]` или `[422 "Unprocessable Entity"]`. При получении таких статусов, система так-же журналирует ошибки (для выясения причины разработчиками), но повторно запросы не отправляет.


### Получение списка транзакций
Для отчетности и периодических актов сверки платежей, модуль должен уметь возвращать список транзакций за определенный параметрами период.
Запрос списка транзакций за, непример, ноябрь 2015 будет выглядеть так:

```
GET /api/transactions?begin=2015-10-31T18:00:00.000Z&end=2015-11-30T18:00:00.000Z
```

_Время в примере указывается в формате ISO с учетом GMT +600 (Asia/Bishkek)_

Пример ответа на такой запрос:

```json
[
  {
    "id": "5648dc5077ba42ee6b13ff6f",
    "requisite": "77273573535",
    "amount": 12.45,
    "status": "success",
    "timestamp": "2018-02-11T16:15:31.390Z",
    "internal": { "id": 10004 }
  },
  {
    "id": "564a50cb77ba42ee6b1407ca",
    "requisite": "77769973535",
    "amount": 25.6,
    "status": "success",
    "timestamp": "2018-02-11T16:15:31.390Z",
    "internal": { "id": 10005 }
  },
  {
    "id": "564a4ff477ba42ee6b1407c9",
    "requisite": "77273573535",
    "amount": 20.0,
    "status": "success",
    "timestamp": "2018-02-11T16:15:31.390Z",
    "internal": { "id": 10006 }
  },
  {
    "id": "564a4fe577ba42ee6b1407c8",
    "requisite": "77273573535",
    "amount": 96.96,
    "status": "failure",
    "message": "Внутренняя ошибка системы",
    "timestamp": "2018-02-11T16:15:31.390Z",
    "internal": { "id": 10007 }
  },
  {
    "id": "564a4e6d77ba42ee6b1407c6",
    "requisite": "77273573535",
    "amount": 108,
    "status": "cancelled",
    "message": "Отменено по запросу клиента",
    "timestamp": "2018-02-11T18:22:03.667Z",
    "internal": { "id": 10008 }
  }
]
Система может запрашивать список транзакций для отчетов периодически или по запросу вручную.
